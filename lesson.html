<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>新概念英语 - 课文点读</title>
    <link rel="stylesheet" href="static/base.css">
    <link rel="stylesheet" href="static/lesson.css">
    <script src="static/utils.js"></script>
    <script src="static/lesson.js"></script>
    <style>
        /* Rules for hiding/showing Chinese/English text */
        #content.en-mode .cn { display: none; }
        #content.cn-mode .en { display: none; }

        /* Copied styles from lesson.css for consistency */
        #display-modes {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0 0;
        }

        #display-modes button {
            background-color: #333;
            color: var(--text-color-dark);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        #display-modes button:hover {
            background-color: #444;
            color: var(--text-color);
        }

        #display-modes button.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3321669220169470" crossorigin="anonymous"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5282BCFM9W"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-5282BCFM9W');</script>
</head>
<body>
<div class="container">
    <a href="index.html">
        <div class="header">
            <h1>新概念英语</h1>
            <p>New Concept English</p>
        </div>
    </a>
</div>
<div class="book-container">
    <a id="book" href="book.html">
        <header class="book-header">
            <img id="book-img" src="images/NCE1.jpg" alt="First Things First">
            <div class="book-title">
                <h3 id="book-title"></h3>
                <hr>
                <p id="lesson-title"></p>
                <div class="lesson-navigation">
                    <button id="prev-lesson" class="nav-btn" title="上一课">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                        </svg>
                        <span>上一课</span>
                    </button>
                    <button id="next-lesson" class="nav-btn" title="下一课">
                        <span>下一课</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>
    </a>
    <hr>
    <main id="content"></main>
</div>

<div class="player-container">
    <div class="custom-player-wrapper">
        <audio id="player"></audio>
        <div class="custom-player">
            <button id="play-pause-btn" class="player-btn play"></button>
            <div class="progress-container">
                <div id="progress-bar">
                    <div id="progress"></div>
                </div>
                <div id="time-display">0:00 / 0:00</div>
            </div>
            <div class="volume-container">
                <button id="volume-btn" class="player-btn volume-high"></button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
            </div>
        </div>
        <div id="playback-modes">
            <button id="mode-ab-loop">A-B循环</button>
            <button id="set-a" style="display: none;">设置A点</button>
            <button id="set-b" style="display: none;">设置B点</button>
            <button id="mode-continuous">连续播放</button>
            <button id="mode-single-loop">单句循环</button>
            <button id="mode-single-play">单次播放</button>
            <div id="dictation-container" class="dictation-container">
                <input type="checkbox" id="dictation-mode">
                <label for="dictation-mode"></label>
                <span>听写模式</span>
            </div>
        </div>
        <div id="playback-speed">
            <button id="speed-0.5x">0.5x</button>
            <button id="speed-1x">1x</button>
            <button id="speed-1.5x">1.5x</button>
            <button id="speed-1.75x">1.75x</button>
            <button id="speed-2x">2x</button>
            <button id="speed-3x">3x</button>
        </div>
        <div id="display-modes">
            <button id="mode-bilingual">中英</button>
            <button id="mode-en">英文</button>
            <button id="mode-cn">中文</button>
        </div>
    </div>
</div>

<footer>
    <hr>
    <p>© 2025 <a target="_blank" href="https://www.hoothin.com">hoothin</a>.</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const hash = window.location.hash.substring(1);
    const parts = hash ? hash.split('/') : [];
    const isCustomLesson = parts[0] === 'CUSTOM';
    let defaultBook = null;
    let lessonSlug = null;
    let customBookName = null;
    let customLessonIndex = null;

    if (isCustomLesson) {
        customBookName = parts[1] ? decodeURIComponent(parts[1]) : null;
        if (parts[2]) {
            const parsedIndex = parseInt(parts[2], 10);
            if (!Number.isNaN(parsedIndex)) {
                customLessonIndex = parsedIndex;
            }
        }
    } else {
        defaultBook = parts[0] ? parts[0].replace('NCE', '') : null;
        lessonSlug = parts[1] ? decodeURIComponent(parts[1]) : null;
    }

    function savePlaybackHistory(currentTime) {
        const titleEl = document.getElementById('lesson-title');
        const title = titleEl ? titleEl.textContent.trim() : '';
        if (!title) return;

        let history = JSON.parse(localStorage.getItem('ncePlaybackHistory') || '[]');

        if (isCustomLesson) {
            if (!customBookName || !Number.isInteger(customLessonIndex)) return;
            history = history.filter(item => !(item.bookType === 'custom' && item.customBookName === customBookName && item.customLessonIndex === customLessonIndex));
            history.unshift({
                bookType: 'custom',
                book: 'CUSTOM',
                customBookName,
                customLessonIndex,
                lesson: String(customLessonIndex),
                title,
                lastPosition: currentTime,
                timestamp: Date.now()
            });
        } else {
            if (!defaultBook || !lessonSlug) return;
            history = history.filter(item => {
                const isDefault = !item.bookType || item.bookType === 'default';
                return !(isDefault && item.book === defaultBook && item.lesson === lessonSlug);
            });
            history.unshift({
                bookType: 'default',
                book: defaultBook,
                lesson: lessonSlug,
                title,
                lastPosition: currentTime,
                timestamp: Date.now()
            });
        }

        if (history.length > 18) {
            history.length = 18;
        }

        localStorage.setItem('ncePlaybackHistory', JSON.stringify(history));
    }

    const player = document.getElementById('player');
    let lastUpdateTime = 0;

    player.addEventListener('loadedmetadata', () => {
        const history = JSON.parse(localStorage.getItem('ncePlaybackHistory') || '[]');
        let currentLessonEntry = null;

        if (isCustomLesson) {
            currentLessonEntry = history.find(item => item.bookType === 'custom' && item.customBookName === customBookName && item.customLessonIndex === customLessonIndex);
        } else {
            currentLessonEntry = history.find(item => {
                const isDefault = !item.bookType || item.bookType === 'default';
                return isDefault && item.book === defaultBook && item.lesson === lessonSlug;
            });
        }

        if (currentLessonEntry && currentLessonEntry.lastPosition) {
            player.currentTime = currentLessonEntry.lastPosition;
        }
        // Save initial position
        savePlaybackHistory(player.currentTime);
    });

    player.addEventListener('timeupdate', () => {
        const now = Date.now();
        // Update history every 5 seconds to avoid excessive writes
        if (now - lastUpdateTime > 5000) {
            savePlaybackHistory(player.currentTime);
            lastUpdateTime = now;
        }
    });

    const content = document.getElementById('content');
    const displayModesContainer = document.getElementById('display-modes');
    let displayModesEnabled = true;

    function applyDisplayMode(mode) {
        if (!mode) return;
        content.classList.remove('bilingual-mode', 'en-mode', 'cn-mode');
        content.classList.add(mode);

        if (!displayModesContainer) {
            return;
        }

        for (const child of displayModesContainer.children) {
            child.classList.remove('active');
        }
        
        const modeName = mode.split('-')[0];
        const activeButton = document.getElementById(`mode-${modeName}`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    function setDisplayModesAvailability(hasTranslation) {
        displayModesEnabled = !!hasTranslation;
        if (displayModesContainer) {
            displayModesContainer.style.display = displayModesEnabled ? '' : 'none';
        }
        if (!displayModesEnabled) {
            applyDisplayMode('en-mode');
            try {
                localStorage.setItem('displayMode', 'en-mode');
            } catch (_) {
                /* noop */
            }
        }
    }

    if (displayModesContainer) {
        displayModesContainer.addEventListener('click', e => {
            if (!displayModesEnabled) return;
            if (e.target.tagName !== 'BUTTON') return;

            const modeName = e.target.id.replace('mode-', ''); // bilingual, en, cn
            const modeClass = `${modeName}-mode`;

            applyDisplayMode(modeClass);
            localStorage.setItem('displayMode', modeClass);
        });
    }

    document.addEventListener('nce:displayModeAvailability', (event) => {
        const detail = event?.detail || {};
        setDisplayModesAvailability(!!detail.hasTranslation);
    });

    // Load saved display mode
    const savedDisplayMode = localStorage.getItem('displayMode') || 'bilingual-mode';
    applyDisplayMode(savedDisplayMode);
});
</script>

</body>
</html>